<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AdsBux - Reklam İzle Robux Kazan</title>
    
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
    
    <!-- Tailwind CSS (for styling and responsiveness) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <!-- Custom Styles -->
    <style>
        :root {
            --primary-color: #007bff; /* Telegram/Mavi ton */
            --primary-light: #e0f0ff;
            --text-color: #1c1c1e;
            --card-bg: #ffffff;
            --bg-color: #f5f5f5;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s;
        }

        .app-container {
            max-width: 450px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--card-bg);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }

        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1.5rem 1rem;
            border-bottom-left-radius: 1.5rem;
            border-bottom-right-radius: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            border: 1px solid var(--primary-light);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px #0056b3;
            line-height: 1;
        }

        .btn-primary:hover {
            background-color: #0069d9;
        }

        .btn-primary:active {
            box-shadow: 0 2px #0056b3;
            transform: translateY(2px);
        }
        
        /* Navigasyon Stilleri */
        .bottom-nav {
            background-color: var(--card-bg);
            border-top: 1px solid var(--primary-light);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .nav-btn {
            color: #777;
            transition: color 0.2s;
        }

        .nav-btn.active {
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .section {
            display: none;
            padding: 1rem;
        }

        /* Animasyonlu Yükleme İndikatörü */
        .dot-pulse {
          position: relative;
          width: 10px;
          height: 10px;
          border-radius: 5px;
          background-color: white;
          color: white;
          animation: dot-pulse 1s infinite linear;
        }
        .dot-pulse::before, .dot-pulse::after {
          content: '';
          display: inline-block;
          position: absolute;
          top: 0;
          width: 10px;
          height: 10px;
          border-radius: 5px;
          background-color: white;
          color: white;
        }
        .dot-pulse::before {
          animation: dot-pulse-before 1s infinite linear;
          left: -15px;
        }
        .dot-pulse::after {
          animation: dot-pulse-after 1s infinite linear;
          left: 15px;
        }

        @keyframes dot-pulse-before {
          0% { transform: scale(1); }
          50%, 100% { transform: scale(0.75); }
        }

        @keyframes dot-pulse {
          0% { transform: scale(0.75); }
          50%, 100% { transform: scale(1); }
        }

        @keyframes dot-pulse-after {
          0% { transform: scale(0.75); }
          50%, 100% { transform: scale(1); }
        }

        /* Modal Stilleri */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

    </style>
</head>
<body>

    <div id="loading-overlay" class="fixed inset-0 bg-white flex flex-col justify-center items-center z-50 transition-opacity duration-300">
        <div class="dot-pulse mb-4"></div>
        <p class="text-gray-600">Uygulama Yükleniyor...</p>
    </div>

    <div class="app-container" id="main-app">
        
        <!-- Header -->
        <div class="header flex items-center justify-between">
            <div>
                <h1 class="text-xl font-extrabold flex items-center">
                    <i class="fas fa-ad mr-2"></i> AdsBux
                </h1>
                <p class="text-sm font-light opacity-80">Reklam İzle, Robux Kazan</p>
            </div>
            <div id="admin-indicator" class="text-xs px-2 py-1 bg-red-500 rounded-full font-bold shadow-md" style="display: none;">
                YÖNETİCİ
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-grow overflow-y-auto">

            <!-- 1. Kazanma Sayfası (Menu/Earn) -->
            <div id="earn-page" class="section active p-4">
                <div id="balance-card" class="card mb-4 text-center">
                    <p class="text-sm text-gray-500 font-semibold mb-1">Toplam Bakiyeniz</p>
                    <h2 class="text-4xl font-extrabold text-indigo-700" id="current-bux-balance">0 BUX</h2>
                    <p class="text-sm text-gray-500 mt-1">~ <span id="current-robux-equivalent">0.00</span> Robux</p>
                </div>

                <div class="card mb-4 text-center">
                    <h3 class="text-xl font-bold mb-3 text-gray-700">BUX Kazan</h3>
                    <p class="text-sm text-gray-500 mb-4">Her reklam izlemede rastgele BUX kazanın!</p>
                    <button id="show-ad-btn" class="btn-primary w-full text-lg flex items-center justify-center" disabled>
                        <i class="fas fa-play-circle mr-2"></i> Reklam İzle ve Kazan
                    </button>
                    <p class="text-xs text-red-500 mt-2" id="ad-error-msg" style="display: none;">Reklam yüklenirken bir hata oluştu.</p>
                </div>

                <div class="card mb-4">
                    <h3 class="text-lg font-bold mb-3 text-gray-700 border-b pb-2">Kazanma Oranları</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between text-md">
                            <span class="font-semibold text-green-600">5 BUX</span>
                            <span class="font-bold">60% Şans</span>
                        </div>
                        <div class="flex justify-between text-md">
                            <span class="font-semibold text-yellow-600">10 BUX</span>
                            <span class="font-bold">25% Şans</span>
                        </div>
                        <div class="flex justify-between text-md">
                            <span class="font-semibold text-orange-600">25 BUX</span>
                            <span class="font-bold">14% Şans</span>
                        </div>
                        <div class="flex justify-between text-md">
                            <span class="font-semibold text-red-600">50 BUX</span>
                            <span class="font-bold">1% Şans</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Cüzdan Sayfası (Wallet/Withdraw) -->
            <div id="wallet-page" class="section p-4">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Cüzdan ve Çekim</h3>
                
                <div id="wallet-balance-card" class="card mb-6 text-center">
                    <p class="text-sm text-gray-500 font-semibold mb-1">Bakiyeniz (100 BUX = 1 Robux)</p>
                    <h2 class="text-4xl font-extrabold text-indigo-700" id="wallet-bux-balance">0 BUX</h2>
                    <p class="text-lg text-gray-700 mt-2 font-bold">~ <span id="wallet-robux-equivalent">0.00</span> Robux</p>
                </div>

                <div class="card mb-4">
                    <h4 class="text-xl font-bold mb-4 text-gray-700">Para Çekme Yöntemi Seçin</h4>
                    
                    <button id="withdraw-robux-btn" class="btn-primary w-full mb-3 text-left flex items-center justify-between">
                        <span class="flex items-center"><i class="fas fa-dollar-sign mr-2"></i> Robux Çekimi (Min 5 Robux)</span>
                        <i class="fas fa-chevron-right"></i>
                    </button>

                    <button id="withdraw-giftcard-btn" class="bg-gray-200 text-gray-500 w-full p-3 rounded-xl flex items-center justify-between cursor-not-allowed">
                        <span class="flex items-center"><i class="fas fa-gift mr-2"></i> Giftcards</span>
                        <span class="text-xs font-semibold">Yakında</span>
                    </button>
                </div>
            </div>

            <!-- 3. Yönetici Paneli (Admin) -->
            <div id="admin-panel" class="section p-4">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Yönetici Paneli</h3>
                <div class="card">
                    <h4 class="text-xl font-bold mb-3 text-gray-700 border-b pb-2">Bekleyen Çekim Talepleri</h4>
                    <div id="withdrawal-requests-list" class="space-y-3">
                        <p class="text-gray-500 text-sm">Yükleniyor...</p>
                    </div>
                </div>
            </div>

            <!-- 4. Hakkında Sayfası (Info) -->
            <div id="info-page" class="section p-4">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Hakkında</h3>
                <div class="card">
                    <p class="text-sm text-gray-600 mb-2">Uygulama Adı: AdsBux</p>
                    <p class="text-sm text-gray-600 mb-2">Telegram Kullanıcı ID'niz: <span id="telegram-id-display" class="font-mono text-xs bg-gray-100 px-1 py-0.5 rounded"></span></p>
                    <p class="text-sm text-gray-600 mb-4">Firebase Kullanıcı ID'niz (UID): <span id="user-uid-display" class="font-mono text-xs bg-gray-100 px-1 py-0.5 rounded"></span></p>
                    
                    <h4 class="text-lg font-bold mt-4 mb-2 border-t pt-2">Destek ve Bilgi</h4>
                    <p class="text-sm text-gray-700">Bu uygulama, reklam izleyerek "BUX" kazanmanıza ve bu BUX'ları Robux'a dönüştürmenize olanak tanır.</p>
                    <ul class="list-disc list-inside text-sm text-gray-600 mt-2">
                        <li>**Dönüşüm:** 100 BUX = 1 Robux</li>
                        <li>**Min. Çekim:** 500 BUX (5 Robux)</li>
                    </ul>
                </div>
            </div>

        </div>

        <!-- Bottom Navigation (Navigasyon) -->
        <div class="bottom-nav flex justify-around p-2 sticky bottom-0">
            <button class="nav-btn active flex flex-col items-center p-2" data-page="earn-page">
                <i class="fas fa-coins text-xl"></i>
                <span class="text-xs mt-1">Kazan</span>
            </button>
            <button class="nav-btn flex flex-col items-center p-2" data-page="wallet-page">
                <i class="fas fa-wallet text-xl"></i>
                <span class="text-xs mt-1">Cüzdan</span>
            </button>
            <button class="nav-btn flex flex-col items-center p-2" data-page="info-page">
                <i class="fas fa-info-circle text-xl"></i>
                <span class="text-xs mt-1">Hakkında</span>
            </button>
        </div>
    </div>

    <!-- Modal for Robux Withdrawal -->
    <div id="robux-withdraw-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h4 class="text-xl font-bold mb-4 text-gray-700 border-b pb-2">Robux Çekimi Yap</h4>
            <p class="text-sm text-gray-600 mb-4">Minimum çekim tutarı 5 Robux'tur (500 BUX).</p>
            
            <div class="mb-4">
                <label for="robux-amount-input" class="block text-sm font-medium text-gray-700">Çekilecek Robux Miktarı</label>
                <input type="number" id="robux-amount-input" min="5" placeholder="Örn: 5, 10, 20" class="mt-1 block w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                <p class="text-xs text-red-500 mt-1 hidden" id="robux-amount-error"></p>
            </div>
            
            <div class="mb-4">
                <label for="gamepass-link-input" class="block text-sm font-medium text-gray-700">Roblox Gamepass Linki</label>
                <input type="url" id="gamepass-link-input" placeholder="https://www.roblox.com/game-pass/..." class="mt-1 block w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                <p class="text-xs text-red-500 mt-1 hidden" id="gamepass-link-error"></p>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('robux-withdraw-modal')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg transition duration-150">İptal</button>
                <button id="confirm-withdraw-btn" class="btn-primary px-4 py-2 flex items-center">
                    <i class="fas fa-check mr-2"></i> Talebi Gönder
                </button>
            </div>
        </div>
    </div>

    <!-- General Message Modal -->
    <div id="message-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <i id="msg-icon" class="fas fa-check-circle text-4xl text-green-500 mb-3"></i>
            <h4 class="text-xl font-bold mb-2 text-gray-700" id="msg-title">Başarılı!</h4>
            <p class="text-sm text-gray-600 mb-4" id="msg-body">İşleminiz başarıyla tamamlandı.</p>
            <button onclick="closeModal('message-modal')" class="px-4 py-2 bg-blue-500 text-white rounded-lg transition duration-150 hover:bg-blue-600">Tamam</button>
        </div>
    </div>


    <script type="module">
        // ====================================================================
        // Firebase ve Temel Ayarlar (Değiştirilmemesi Gereken Global Değişkenler)
        // ====================================================================
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, addDoc, serverTimestamp, arrayUnion, setLogLevel, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Değişkenler
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let userBuxBalance = 0;
        let isAdmin = false;

        // Firebase Paths (Güvenlik Kurallarına Uygun)
        const USER_DATA_PATH = (uid) => `artifacts/${appId}/users/${uid}/adsbux/data`; 
        const WITHDRAWAL_COLLECTION_PATH = `artifacts/${appId}/public/data/adsbux_withdrawals/requests`;

        // Yönetici Telegram ID'leri (Kendi Telegram ID'nizi ekleyin)
        const ADMIN_TELEGRAM_IDS = [54321, 12345]; // Örnek ID'ler. Kendi ID'nizi buraya yazın.

        // ====================================================================
        // Utility Functions
        // ====================================================================

        function showModal(id, title = '', body = '', iconClass = 'fas fa-check-circle text-green-500') {
            const modal = document.getElementById(id);
            if (modal === document.getElementById('message-modal')) {
                document.getElementById('msg-title').textContent = title;
                document.getElementById('msg-body').textContent = body;
                document.getElementById('msg-icon').className = `${iconClass} text-4xl mb-3`;
            }
            modal.classList.remove('hidden');
        }

        window.closeModal = function(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function getUidFromTelegramId(telegramId) {
            // Basit bir karma algoritması ile Telegram ID'den benzersiz UID üretme (Firestore'da kullanıcı belgesi için)
            return `tg-${telegramId}`;
        }
        
        function formatNumber(num) {
            return new Intl.NumberFormat('tr-TR').format(Math.floor(num));
        }

        function calculateRobux(bux) {
            return bux / 100;
        }

        function updateBalanceUI(bux) {
            userBuxBalance = bux;
            const robux = calculateRobux(bux);
            
            document.getElementById('current-bux-balance').textContent = `${formatNumber(bux)} BUX`;
            document.getElementById('current-robux-equivalent').textContent = robux.toFixed(2);
            document.getElementById('wallet-bux-balance').textContent = `${formatNumber(bux)} BUX`;
            document.getElementById('wallet-robux-equivalent').textContent = robux.toFixed(2);

            const showAdBtn = document.getElementById('show-ad-btn');
            showAdBtn.disabled = false; // Bakiye gösterildiğinde butonu etkinleştir.
            showAdBtn.textContent = 'Reklam İzle ve Kazan';
        }

        // ====================================================================
        // UI Navigation
        // ====================================================================

        function showSection(pageId) {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(pageId).style.display = 'block';

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.nav-btn[data-page="${pageId}"]`).classList.add('active');

            // Cüzdan sayfasına geçildiğinde bakiyeyi güncelle
            if (pageId === 'wallet-page') {
                updateBalanceUI(userBuxBalance);
            }
        }

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => showSection(btn.dataset.page));
        });


        // ====================================================================
        // Firebase CRUD & Realtime Listeners
        // ====================================================================
        
        async function getOrCreateUserData() {
            const userRef = doc(db, USER_DATA_PATH(userId), 'data');
            const docSnap = await getDoc(userRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                userBuxBalance = data.bux || 0;
                updateBalanceUI(userBuxBalance);
                return data;
            } else {
                await setDoc(userRef, {
                    telegramId: userId,
                    bux: 0,
                    createdAt: serverTimestamp(),
                    lastAdView: null
                });
                return { telegramId: userId, bux: 0 };
            }
        }

        function setupUserListener() {
            if (!userId) return;

            const userRef = doc(db, USER_DATA_PATH(userId), 'data');
            onSnapshot(userRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    updateBalanceUI(data.bux || 0);
                } else {
                    getOrCreateUserData(); // Belge silinirse tekrar oluştur
                }
            }, (error) => {
                console.error("Kullanıcı veri dinleyicisi hatası:", error);
                showModal('message-modal', 'Hata', 'Kullanıcı verisi yüklenirken bir sorun oluştu.', 'fas fa-exclamation-triangle text-red-500');
            });
        }
        
        function setupAdminListener() {
            if (!isAdmin) return;
            const requestsCol = collection(db, WITHDRAWAL_COLLECTION_PATH);
            const q = query(requestsCol);

            onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('withdrawal-requests-list');
                listEl.innerHTML = ''; 
                
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-500 text-sm py-2">Henüz bekleyen çekim talebi yok.</p>';
                    return;
                }

                snapshot.docs.forEach(docSnap => {
                    const req = docSnap.data();
                    const reqId = docSnap.id;
                    const date = req.timestamp ? new Date(req.timestamp.toDate()).toLocaleString() : 'Bilinmiyor';

                    const item = document.createElement('div');
                    item.className = 'p-3 border rounded-lg shadow-sm bg-blue-50';
                    item.innerHTML = `
                        <p class="font-semibold text-gray-800">${req.robuxAmount} Robux Talebi</p>
                        <p class="text-xs text-gray-500">Kullanıcı: ${req.telegramId} (${req.userId})</p>
                        <p class="text-xs text-gray-500">Link: <a href="${req.gamepassLink}" target="_blank" class="text-blue-600 hover:underline">${req.gamepassLink.substring(0, 30)}...</a></p>
                        <p class="text-xs text-gray-500">Tarih: ${date}</p>
                        <div class="mt-2 flex space-x-2">
                            <button data-id="${reqId}" class="admin-action-btn bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded-md" data-action="complete">Tamamla</button>
                            <button data-id="${reqId}" class="admin-action-btn bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded-md" data-action="reject">Reddet</button>
                        </div>
                    `;
                    listEl.appendChild(item);
                });

                // Olay Dinleyicilerini Ekle
                listEl.querySelectorAll('.admin-action-btn').forEach(btn => {
                    btn.addEventListener('click', handleAdminAction);
                });

            }, (error) => {
                console.error("Admin dinleyicisi hatası:", error);
            });
        }

        async function handleAdminAction(event) {
            const btn = event.target;
            const reqId = btn.dataset.id;
            const action = btn.dataset.action;

            if (!reqId || !action) return;

            try {
                // Sadece silme işlemi (Tamamlama/Reddetme sonrası listeden kaldırılır)
                await deleteDoc(doc(db, WITHDRAWAL_COLLECTION_PATH, reqId));
                showModal('message-modal', 'İşlem Başarılı', `Talep (${reqId}) ${action === 'complete' ? 'tamamlandı' : 'reddedildi'} olarak listeden kaldırıldı.`, 'fas fa-check-circle text-green-500');

            } catch (error) {
                console.error("Yönetici işlemi hatası:", error);
                showModal('message-modal', 'Hata', `İşlem sırasında bir hata oluştu: ${error.message}`, 'fas fa-exclamation-triangle text-red-500');
            }
        }

        // ====================================================================
        // Ad Viewing and Reward Logic
        // ====================================================================

        function getBuxReward() {
            const rand = Math.random();
            if (rand < 0.60) return 5;   // 60%
            if (rand < 0.85) return 10;  // 25% (0.60 - 0.85)
            if (rand < 0.99) return 25;  // 14% (0.85 - 0.99)
            return 50;                   // 1% (0.99 - 1.00)
        }
        
        async function rewardUser(buxAmount) {
            if (!userId) {
                console.error("Kullanıcı kimliği yok, ödül verilemiyor.");
                return;
            }

            const userRef = doc(db, USER_DATA_PATH(userId), 'data');
            const newBalance = (userBuxBalance || 0) + buxAmount;

            try {
                await updateDoc(userRef, {
                    bux: newBalance,
                    lastAdView: serverTimestamp(),
                });
                
                updateBalanceUI(newBalance);
                showModal('message-modal', 'Tebrikler!', `${buxAmount} BUX kazandınız!`, 'fas fa-star text-yellow-500');
                
            } catch (error) {
                console.error("Ödül verme hatası:", error);
                showModal('message-modal', 'Hata', 'Bakiyeniz güncellenemedi. Lütfen tekrar deneyin.', 'fas fa-exclamation-triangle text-red-500');
            }
        }
        
        async function handleShowAd() {
            const btn = document.getElementById('show-ad-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="dot-pulse"></div>';

            // Adexora reklam kodunu çalıştır
            if (typeof window.showAdexora !== 'function') {
                 // Adexora script'i yüklenmemişse bir süre sonra tekrar dene
                setTimeout(() => {
                    handleShowAd();
                }, 1000);
                return;
            }

            try {
                // Kullanıcının sağladığı reklam kodu: id=663
                await window.showAdexora({ id: 663 }); 
                
                // Reklam başarıyla izlendi, ödülü hesapla ve ver
                const reward = getBuxReward();
                await rewardUser(reward);

            } catch (e) {
                console.error("Reklam gösterimi hatası:", e);
                const errorMsg = document.getElementById('ad-error-msg');
                errorMsg.style.display = 'block';
                showModal('message-modal', 'Hata', 'Reklam gösterilemedi veya atlandı. Lütfen tekrar deneyin.', 'fas fa-times-circle text-red-500');
                
            } finally {
                // Butonu tekrar etkinleştir
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play-circle mr-2"></i> Reklam İzle ve Kazan';
            }
        }

        // ====================================================================
        // Withdrawal Logic
        // ====================================================================

        async function handleWithdrawalRequest() {
            const robuxInput = document.getElementById('robux-amount-input');
            const linkInput = document.getElementById('gamepass-link-input');
            const confirmBtn = document.getElementById('confirm-withdraw-btn');

            const robuxAmount = parseInt(robuxInput.value);
            const gamepassLink = linkInput.value.trim();
            const buxToDeduct = robuxAmount * 100;

            // Hata eleme
            document.getElementById('robux-amount-error').classList.add('hidden');
            document.getElementById('gamepass-link-error').classList.add('hidden');

            let isValid = true;

            if (isNaN(robuxAmount) || robuxAmount < 5) {
                document.getElementById('robux-amount-error').textContent = 'Minimum 5 Robux (500 BUX) çekebilirsiniz.';
                document.getElementById('robux-amount-error').classList.remove('hidden');
                isValid = false;
            }

            if (buxToDeduct > userBuxBalance) {
                document.getElementById('robux-amount-error').textContent = `Yetersiz bakiye. Çekmek için ${buxToDeduct} BUX (Mevcut: ${userBuxBalance} BUX) gerekiyor.`;
                document.getElementById('robux-amount-error').classList.remove('hidden');
                isValid = false;
            }

            if (!gamepassLink || !gamepassLink.includes('roblox.com/game-pass/')) {
                document.getElementById('gamepass-link-error').textContent = 'Geçerli bir Roblox Gamepass linki girmelisiniz.';
                document.getElementById('gamepass-link-error').classList.remove('hidden');
                isValid = false;
            }

            if (!isValid) return;
            
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<div class="dot-pulse"></div>';

            try {
                // 1. Bakiyeyi Düş
                const userRef = doc(db, USER_DATA_PATH(userId), 'data');
                const newBalance = userBuxBalance - buxToDeduct;

                await updateDoc(userRef, {
                    bux: newBalance,
                    totalWithdrawnRobux: arrayUnion({ robux: robuxAmount, timestamp: serverTimestamp() })
                });

                // 2. Çekim Talebini Admin Paneline Gönder (Public Collection)
                const requestsCol = collection(db, WITHDRAWAL_COLLECTION_PATH);
                await addDoc(requestsCol, {
                    userId: userId,
                    telegramId: Telegram.WebApp.initDataUnsafe.user.id,
                    robuxAmount: robuxAmount,
                    buxDeducted: buxToDeduct,
                    gamepassLink: gamepassLink,
                    status: 'Pending',
                    timestamp: serverTimestamp()
                });

                closeModal('robux-withdraw-modal');
                showModal('message-modal', 'Talep Gönderildi', 'Robux çekim talebiniz yönetici paneline iletildi. En kısa sürede gamepass linkiniz üzerinden ödemeniz yapılacaktır.', 'fas fa-clock text-blue-500');

                // UI'ı temizle
                robuxInput.value = '';
                linkInput.value = '';

            } catch (error) {
                console.error("Çekim talebi hatası:", error);
                // Hata oluşursa bakiyeyi geri yüklemek gerekebilir, ancak basitlik için sadece hata mesajı gösteriliyor.
                showModal('message-modal', 'Hata', 'Çekim talebi gönderilirken bir sorun oluştu. Lütfen tekrar deneyin.', 'fas fa-exclamation-triangle text-red-500');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Talebi Gönder';
            }
        }

        // ====================================================================
        // Event Listeners Setup
        // ====================================================================

        function setupEventListeners() {
            document.getElementById('show-ad-btn').addEventListener('click', handleShowAd);
            document.getElementById('withdraw-robux-btn').addEventListener('click', () => showModal('robux-withdraw-modal'));
            document.getElementById('withdraw-giftcard-btn').addEventListener('click', () => {
                showModal('message-modal', 'Yakında', 'Giftcard ile çekim seçeneği yakında eklenecektir.', 'fas fa-gift text-purple-500');
            });
            document.getElementById('confirm-withdraw-btn').addEventListener('click', handleWithdrawalRequest);
        }

        // ====================================================================
        // Application Initialization
        // ====================================================================

        async function initApp() {
            setLogLevel('debug');

            if (!Telegram.WebApp || !Telegram.WebApp.initDataUnsafe || !Telegram.WebApp.initDataUnsafe.user) {
                console.error("Telegram WebApp başlatılamadı. Sadece Telegram içinde çalışır.");
                document.getElementById('loading-overlay').innerHTML = '<p class="text-red-500 font-bold">Lütfen uygulamayı Telegram içinde açın.</p>';
                return;
            }

            // Telegram arayüzünü ayarla
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            Telegram.WebApp.MainButton.hide();

            // Firebase'i başlat
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Kullanıcı kimliğini al (Telegram ID'den türetilmiş)
            const telegramId = Telegram.WebApp.initDataUnsafe.user.id;
            userId = getUidFromTelegramId(telegramId);

            // Admin Kontrolü
            if (ADMIN_TELEGRAM_IDS.includes(telegramId)) {
                isAdmin = true;
                document.getElementById('admin-indicator').style.display = 'block';
                // Yönetici navigasyon butonunu ekle
                const nav = document.querySelector('.bottom-nav');
                if (!document.querySelector('.nav-btn[data-page="admin-panel"]')) {
                    const adminBtn = document.createElement('button');
                    adminBtn.className = 'nav-btn flex flex-col items-center p-2';
                    adminBtn.dataset.page = 'admin-panel';
                    adminBtn.innerHTML = '<i class="fas fa-user-shield text-xl"></i><span class="text-xs mt-1">Admin</span>';
                    nav.appendChild(adminBtn);
                    adminBtn.addEventListener('click', () => showSection('admin-panel')); 
                }
            }

            // UI'daki Telegram ID'yi göster
            document.getElementById('telegram-id-display').textContent = telegramId;
            document.getElementById('user-uid-display').textContent = userId;

            // Firebase Yetkilendirme
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Yetkilendirme Hatası:", error);
                document.getElementById('loading-overlay').innerHTML = `<p class="text-red-500 font-bold">Yetkilendirme hatası: ${error.message}</p>`;
                return;
            }

            // Auth durumunda UID'yi kontrol et (önlem)
            if (auth.currentUser) {
                // UI'ı güncelle
                await getOrCreateUserData();
                setupUserListener();
                setupEventListeners();
                if (isAdmin) {
                    setupAdminListener();
                }
                
                showSection('earn-page'); 
                document.getElementById('loading-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 300);

            } else {
                console.error("Kullanıcı oturumu başlatılamadı.");
                document.getElementById('loading-overlay').innerHTML = '<p class="text-red-500 font-bold">Oturum başlatılamadı. Lütfen uygulamayı kapatıp tekrar açın.</p>';
            }
        }
        
        // Uygulamayı başlat
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

    <!-- Kullanıcının sağladığı reklam script'i -->
    <script src="https://adexora.com/cdn/ads.js?id=663"></script>

</body>
</html>

