<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AdsBux - Robux Kazan</title>
    
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
    
    <!-- Adexora Reklam Kodu -->
    <script src="https://adexora.com/cdn/ads.js?id=663"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <!-- Tailwind CSS (Aesthetic Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, serverTimestamp, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore log seviyesini Debug olarak ayarlayın
        setLogLevel('Debug');

        // CANVAS Ortam Değişkenleri
        // Firebase yapılandırması
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{"apiKey": "AIzaSyA4hyg3BbR--b5c_ig01yr_OblTZP4TsDE","authDomain": "adsbux-73efc.firebaseapp.com","databaseURL": "https://adsbux-73efc-default-rtdb.firebaseio.com","projectId": "adsbux-73efc","storageBucket": "adsbux-73efc.firebasestorage.app","messagingSenderId": "396593744688","appId": "1:396593744688:web:03d7020fa05c9296d396f5","measurementId": "G-SFXVSS6MRJ"}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'adsbux-default';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = '';
        let telegramId = '';
        let userBuxBalance = 0;
        let isAuthReady = false;

        // BOT AYARLARI
        const BUX_PER_ROBUX = 100;
        const MIN_ROBUX_WITHDRAW = 5; // 5 Robux = 500 BUX
        const WITHDRAWAL_COMMISSION_PERCENT = 30;
        // LÜTFEN BU KISMI GERÇEK TELEGRAM ID'LERİNİZLE DEĞİŞTİRİN (Tırnak içinde string olarak)
        const ADMIN_TELEGRAM_IDS = ['TEST_USER_12345']; // Örnek Admin Telegram ID'si (String olmalı)

        // Fonksiyon: Telegram ID'den benzersiz User ID üretimi
        const getUidFromTelegramId = (tgId) => `tg_${tgId}`;

        // Fonksiyon: Belirtilen olasılıklara göre BUX ödülü hesaplama
        const getRewardAmountWithOdds = () => {
            // İstenilen oranlar: 5: %55, 10: %25, 25: %14, 50: %1 (Toplam %95 yapar).
            // Geri kalan %5'i 5 BUX'a ekleyerek toplamı %100 yapıyorum.
            const odds = [
                { amount: 5, chance: 60 }, // %55 + %5 (kalan)
                { amount: 10, chance: 25 },
                { amount: 25, chance: 14 },
                { amount: 50, chance: 1 }
            ];

            const totalWeight = odds.reduce((sum, item) => sum + item.chance, 0);
            let random = Math.random() * totalWeight;

            for (const item of odds) {
                if (random < item.chance) {
                    return item.amount;
                }
                random -= item.chance;
            }
            return 5; // Varsayılan değer (asla çalışmamalı)
        };
        
        // Firestore Yolunu Oluşturma
        const getUserDocRef = (uid) => doc(db, 'artifacts', appId, 'users', uid, 'data', 'profile');
        // Admin paneli için public collection (herkes okuyup yazabilir kuralı ile güvende)
        const getWithdrawalCollectionRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'withdrawals');

        // Kullanıcı Verilerini Dinleme
        const setupUserListener = () => {
            if (!db || !userId) return;

            const userDocRef = getUserDocRef(userId);

            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userBuxBalance = data.buxBalance || 0;
                } else {
                    userBuxBalance = 0;
                    // Yeni kullanıcı oluşturma
                    setDoc(userDocRef, {
                        telegramId: telegramId,
                        buxBalance: 0,
                        lastAdTime: serverTimestamp(),
                        createdAt: serverTimestamp(),
                        referral: ''
                    });
                }
                updateUI();
            }, (error) => {
                console.error("Firestore dinleme hatası:", error);
                showToast('Hata: Kullanıcı verileri yüklenemedi.', 'error');
            });

            // Admin panelini dinleme (Eğer admin ise)
            if (ADMIN_TELEGRAM_IDS.includes(telegramId.toString())) {
                setupAdminListener();
            }
        };

        // ADMIN PANELİ İŞLEVSELLİĞİ
        const setupAdminListener = () => {
             if (!db) return;

             // Sadece "Beklemede" statüsündeki talepleri getir
             const withdrawalsQuery = query(getWithdrawalCollectionRef(), where('status', '==', 'Beklemede'));
             
             onSnapshot(withdrawalsQuery, (snapshot) => {
                 const requests = [];
                 snapshot.forEach(doc => {
                     requests.push({ id: doc.id, ...doc.data() });
                 });
                 updateAdminPanel(requests);
             }, (error) => {
                 console.error("Admin panel dinleme hatası:", error);
                 showToast('Admin verileri yüklenemedi.', 'error');
             });
        };

        window.fulfillWithdrawal = async (requestId, isSuccessful) => {
            const requestRef = doc(getWithdrawalCollectionRef(), requestId);
            
            try {
                // İşlemi Transaction içinde yapıyoruz ki bakiye geri yükleme güvenli olsun
                await runTransaction(db, async (transaction) => {
                    const requestSnap = await transaction.get(requestRef);
                    if (!requestSnap.exists()) {
                        throw new Error("Talep bulunamadı!");
                    }
                    
                    const requestData = requestSnap.data();
                    if (requestData.status !== 'Beklemede') {
                        throw new Error("Talep zaten işlenmiş.");
                    }

                    // Talebi güncelle
                    transaction.update(requestRef, {
                        status: isSuccessful ? 'Ödendi' : 'Reddedildi',
                        processedAt: serverTimestamp(),
                        processedBy: userId
                    });

                    // Reddedilirse (isSuccessful === false) bakiyeyi geri yükle
                    if (!isSuccessful) {
                        const userRef = getUserDocRef(requestData.userUid);
                        const userSnap = await transaction.get(userRef);
                        
                        if (userSnap.exists()) {
                             const currentBalance = userSnap.data().buxBalance || 0;
                             const buxToReturn = requestData.buxAmount;
                             
                             transaction.update(userRef, {
                                 buxBalance: currentBalance + buxToReturn
                             });
                             showToast(`Talep reddedildi. ${buxToReturn} BUX kullanıcıya iade edildi.`, 'info');
                        }
                    }
                });
                
                if (isSuccessful) {
                    showToast(`Talep #${requestId.substring(0, 8)} başarıyla ÖDENDİ olarak işaretlendi.`, 'success');
                }

            } catch (e) {
                console.error("Talep işleme hatası:", e);
                showToast(`Talep işlenirken bir hata oluştu: ${e.message}`, 'error');
            }
        };
        // END ADMIN PANELİ İŞLEVSELLİĞİ


        // UI Güncelleme Fonksiyonu
        const updateUI = () => {
            document.getElementById('bux-balance').textContent = userBuxBalance.toFixed(2);
            document.getElementById('bux-balance-wallet').textContent = userBuxBalance.toFixed(2);
            
            // Wallet dönüşümünü güncelle
            const robuxEquivalent = (userBuxBalance / BUX_PER_ROBUX);
            document.getElementById('wallet-robux-equivalent').textContent = robuxEquivalent.toFixed(2);

            // Çekim sayfasını güncelle
            const maxWithdrawRobuxAmount = Math.floor(userBuxBalance / BUX_PER_ROBUX);
            document.getElementById('max-withdraw-robux').textContent = maxWithdrawRobuxAmount;
            document.getElementById('withdraw-input').placeholder = `Min ${MIN_ROBUX_WITHDRAW} Robux - Max ${maxWithdrawRobuxAmount} Robux`;
            
            // Çekim detaylarını güncelle
            updateWithdrawalDetails();

            // Anasayfa oranları
            const oddsHtml = `
                <div class="flex justify-between items-center p-2 rounded-lg bg-blue-50/50">
                    <span class="font-semibold text-blue-700">5 BUX:</span>
                    <span class="text-lg font-bold text-blue-900">60%</span>
                </div>
                <div class="flex justify-between items-center p-2 rounded-lg bg-blue-50/50">
                    <span class="font-semibold text-blue-700">10 BUX:</span>
                    <span class="text-lg font-bold text-blue-900">25%</span>
                </div>
                <div class="flex justify-between items-center p-2 rounded-lg bg-blue-50/50">
                    <span class="font-semibold text-blue-700">25 BUX:</span>
                    <span class="text-lg font-bold text-blue-900">14%</span>
                </div>
                <div class="flex justify-between items-center p-2 rounded-lg bg-blue-50/50">
                    <span class="font-semibold text-blue-700">50 BUX:</span>
                    <span class="text-lg font-bold text-blue-900">1%</span>
                </div>
            `;
             document.getElementById('bux-rates').innerHTML = oddsHtml;
        };

        const updateAdminPanel = (requests) => {
            const list = document.getElementById('withdrawal-request-list');
            if (!list) return;

            list.innerHTML = '';
            if (requests.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center p-4">Bekleyen çekim talebi yok.</p>';
                return;
            }

            requests.forEach(req => {
                const li = document.createElement('li');
                li.className = 'p-3 mb-2 bg-white rounded-xl shadow flex flex-col space-y-1 border-l-4 border-red-500';
                li.innerHTML = `
                    <p class="text-xs font-semibold text-red-600">TALEP ID: #${req.id.substring(0, 8)}</p>
                    <p class="text-lg font-bold text-gray-800">${req.requestedAmountRobux} Robux Talep Edildi</p>
                    <p class="text-sm text-gray-600">Kullanıcı TG ID: ${req.userTelegramId}</p>
                    <p class="text-sm text-green-600 font-bold">Ödenecek Net: ${req.netAmountRobux.toFixed(2)} Robux</p>
                    <p class="text-sm text-gray-600 break-all">Gamepass Linki: <a href="${req.gamepassLink}" target="_blank" class="text-blue-500 hover:underline">Görüntüle</a></p>
                    <p class="text-xs text-gray-400">Düşülen BUX: ${req.buxAmount} | Komisyon: ${req.commissionAmountRobux.toFixed(2)} Robux</p>
                    <div class="flex space-x-2 mt-2">
                        <button onclick="window.fulfillWithdrawal('${req.id}', true)" class="flex-1 bg-green-500 text-white p-2 rounded-lg text-sm hover:bg-green-600 transition duration-150">Ödendi İşaretle</button>
                        <button onclick="window.fulfillWithdrawal('${req.id}', false)" class="flex-1 bg-red-500 text-white p-2 rounded-lg text-sm hover:bg-red-600 transition duration-150">Reddet (BUX İade)</button>
                    </div>
                `;
                list.appendChild(li);
            });
        };

        // KOMİSYON HESAPLAMA VE GÖRSELLEŞTİRME
        const updateWithdrawalDetails = () => {
            const robuxInput = document.getElementById('withdraw-input');
            const maxRobux = Math.floor(userBuxBalance / BUX_PER_ROBUX);
            const requestedRobux = parseInt(robuxInput.value) || 0;
            const withdrawBtn = document.getElementById('confirm-withdraw-btn');
            
            let commissionAmountRobux = 0;
            let netAmountRobux = 0;
            
            if (requestedRobux < MIN_ROBUX_WITHDRAW || requestedRobux > maxRobux || isNaN(requestedRobux)) {
                // Hata durumu
                withdrawBtn.disabled = true;
                if (requestedRobux < MIN_ROBUX_WITHDRAW && requestedRobux > 0) {
                     document.getElementById('withdraw-error').textContent = `Minimum çekim ${MIN_ROBUX_WITHDRAW} Robux'tur.`;
                } else if (requestedRobux > maxRobux) {
                     document.getElementById('withdraw-error').textContent = `Maksimum çekim bakiyeniz: ${maxRobux} Robux.`;
                } else {
                     document.getElementById('withdraw-error').textContent = '';
                }
            } else {
                // Başarılı hesaplama
                commissionAmountRobux = (requestedRobux * WITHDRAWAL_COMMISSION_PERCENT) / 100;
                netAmountRobux = requestedRobux - commissionAmountRobux;
                withdrawBtn.disabled = false;
                document.getElementById('withdraw-error').textContent = '';
            }
            
            document.getElementById('commission-display').textContent = `${commissionAmountRobux.toFixed(2)} Robux`;
            document.getElementById('net-robux-display').textContent = `${netAmountRobux.toFixed(2)} Robux`;
        };
        // END KOMİSYON HESAPLAMA


        // Fonksiyon: Reklam İzleme ve BUX Kazanma
        const watchAd = async () => {
            if (!db || !userId || !isAuthReady) {
                showToast('Lütfen uygulamanın yüklenmesini bekleyin.', 'error');
                return;
            }

            const loadingId = showToast('Reklam yükleniyor...', 'info', true);

            window.showAdexora()
                .then(async () => {
                    closeToast(loadingId);
                    
                    const rewardAmount = getRewardAmountWithOdds();
                    const userDocRef = getUserDocRef(userId);

                    // Transaction ile güvenli bakiye güncelleme
                    await runTransaction(db, async (transaction) => {
                        const userDoc = await transaction.get(userDocRef);
                        const currentBalance = userDoc.data().buxBalance || 0;
                        const newBalance = currentBalance + rewardAmount;
                        
                        transaction.update(userDocRef, {
                            buxBalance: newBalance,
                            lastAdTime: serverTimestamp()
                        });
                        userBuxBalance = newBalance; // Yerel değişkeni güncelle
                    });

                    // Başarılı ödül mesajı (İstenilen düzeltme)
                    showToast(`Tebrikler! Reklam izlediğiniz için ${rewardAmount} BUX kazandınız!`, 'success');
                    updateUI(); // Arayüzü hemen güncelle
                })
                .catch(e => {
                    closeToast(loadingId);
                    console.error("Adexora Hatası:", e);
                    showToast('Reklam gösterilemedi veya kapattınız. Lütfen tekrar deneyin.', 'error');
                });
        };

        // Fonksiyon: Çekim Talebi Oluşturma
        const requestWithdrawal = async () => {
            if (!isAuthReady) {
                showToast('Hata: Oturum hazır değil.', 'error');
                return;
            }

            const selectedType = document.querySelector('input[name="withdraw-type"]:checked').value;
            const withdrawInput = document.getElementById('withdraw-input');
            const gamepassLinkInput = document.getElementById('gamepass-link-input');
            
            const requestedRobux = parseInt(withdrawInput.value);
            const maxRobux = Math.floor(userBuxBalance / BUX_PER_ROBUX);

            if (isNaN(requestedRobux) || requestedRobux < MIN_ROBUX_WITHDRAW || requestedRobux > maxRobux) {
                showToast('Geçersiz veya yetersiz Robux miktarı.', 'error');
                return;
            }

            const requiredBux = requestedRobux * BUX_PER_ROBUX;

            if (selectedType === 'robux' && (!gamepassLinkInput.value || !gamepassLinkInput.value.startsWith('http'))) {
                 showToast('Robux çekimi için geçerli Gamepass linki girin.', 'error');
                 return;
            }
            if (selectedType === 'giftcard') {
                 showToast('Giftcard çekimleri şu an için aktif değildir.', 'error');
                 return;
            }

            // Komisyon hesaplama
            const commissionAmountRobux = (requestedRobux * WITHDRAWAL_COMMISSION_PERCENT) / 100;
            const netAmountRobux = requestedRobux - commissionAmountRobux;

            const confirmText = `${requestedRobux} Robux talep ediyorsunuz.\nKomisyon (%${WITHDRAWAL_COMMISSION_PERCENT}): ${commissionAmountRobux.toFixed(2)} Robux.\nNet ödenecek miktar: ${netAmountRobux.toFixed(2)} Robux.\nDevam etmek istiyor musunuz?`;
            
            showCustomConfirm(confirmText, async () => {
                const loadingId = showToast('Çekim talebi oluşturuluyor...', 'info', true);
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const userDocRef = getUserDocRef(userId);
                        const userDoc = await transaction.get(userDocRef);
                        const currentBalance = userDoc.data().buxBalance || 0;

                        if (currentBalance < requiredBux) {
                            throw new Error("Yetersiz BUX bakiyesi.");
                        }

                        // 1. Kullanıcının BUX bakiyesini düşür
                        const newBuxBalance = currentBalance - requiredBux;
                        transaction.update(userDocRef, {
                            buxBalance: newBuxBalance
                        });
                        userBuxBalance = newBuxBalance; // Yerel değişkeni güncelle

                        // 2. Çekim talebini admin paneline kaydet
                        transaction.set(doc(getWithdrawalCollectionRef()), {
                            userUid: userId,
                            userTelegramId: telegramId,
                            type: selectedType,
                            buxAmount: requiredBux, // Düşülen BUX miktarı (geri iade için gerekli)
                            requestedAmountRobux: requestedRobux, // Admin panelinde görünecek tam miktar
                            commissionPercent: WITHDRAWAL_COMMISSION_PERCENT,
                            commissionAmountRobux: commissionAmountRobux,
                            netAmountRobux: netAmountRobux, // Kullanıcıya ödenecek net miktar
                            gamepassLink: selectedType === 'robux' ? gamepassLinkInput.value : null,
                            status: 'Beklemede',
                            requestedAt: serverTimestamp()
                        });
                    });

                    closeToast(loadingId);
                    showToast('Çekim talebiniz başarıyla alındı. Admin onayı bekleniyor.', 'success');
                    withdrawInput.value = '';
                    gamepassLinkInput.value = '';
                    updateUI();
                    window.showSection('menu-page'); // Ana menüye dön
                } catch (e) {
                    closeToast(loadingId);
                    console.error("Çekim talebi hatası:", e);
                    showToast(`Çekim talebi gönderilemedi: ${e.message}`, 'error');
                }
            });
        };

        // Ortak Global Fonksiyonlar
        window.showSection = (sectionId) => {
            document.querySelectorAll('.app-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`.nav-btn[data-page="${sectionId}"]`);
            if (activeBtn) {
                 activeBtn.classList.add('active');
            }
            if (sectionId === 'withdraw-page') {
                updateWithdrawalOptions();
                updateWithdrawalDetails(); // Sayfa açıldığında hesaplamayı yap
            }
        };

        const updateWithdrawalOptions = () => {
            const robuxRadio = document.getElementById('withdraw-robux');
            const giftcardRadio = document.getElementById('withdraw-giftcard');
            const gamepassLinkContainer = document.getElementById('gamepass-link-container');
            const giftcardComingSoon = document.getElementById('giftcard-coming-soon');
            const withdrawButton = document.getElementById('confirm-withdraw-btn');

            if (robuxRadio.checked) {
                gamepassLinkContainer.classList.remove('hidden');
                giftcardComingSoon.classList.add('hidden');
                withdrawButton.disabled = false;
                withdrawButton.textContent = 'Çekim Yap';
            } else if (giftcardRadio.checked) {
                gamepassLinkContainer.classList.add('hidden');
                giftcardComingSoon.classList.remove('hidden');
                withdrawButton.disabled = true;
                withdrawButton.textContent = 'Yakında (Çekim Kapalı)';
            }
            updateWithdrawalDetails(); // Seçenek değiştiğinde hesaplamayı yeniden yap
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('withdraw-robux').addEventListener('change', updateWithdrawalOptions);
            document.getElementById('withdraw-giftcard').addEventListener('change', updateWithdrawalOptions);
            document.getElementById('withdraw-input').addEventListener('input', updateWithdrawalDetails); // Anlık komisyon hesaplama
            
            window.showSection('loading-page'); // Başlangıçta yükleme ekranını göster
            
            // Event Listener'ları tanımla
            document.getElementById('watch-ad-btn').addEventListener('click', watchAd);
            document.getElementById('confirm-withdraw-btn').addEventListener('click', requestWithdrawal);
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => window.showSection(e.currentTarget.dataset.page));
            });
        });

        const initApp = async () => {
            // Firebase Başlatma
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Telegram Web App Hazırlığı
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                // Telegram ID'yi güvenli bir şekilde al, yoksa test kullanıcısı ata
                const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
                telegramId = tgUser?.id ? tgUser.id.toString() : 'TEST_USER_12345';
            } else {
                telegramId = 'TEST_USER_12345'; // Test için
            }

            userId = getUidFromTelegramId(telegramId);
            
            // Kimlik Doğrulama
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth hatası:", error);
                // Auth başarısız olursa anonim kalabilir veya hata mesajı gösterebilir
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Auth tamamlandı ve user nesnesi var
                    isAuthReady = true;

                    // Admin Kontrolü ve Admin Butonu Ekleme
                    if (ADMIN_TELEGRAM_IDS.includes(telegramId)) {
                         document.getElementById('admin-indicator').style.display = 'block';
                         const nav = document.querySelector('.bottom-nav');
                         // Admin butonu zaten ekli değilse ekle
                         if (!document.querySelector('.nav-btn[data-page="admin-panel"]')) {
                             const adminBtn = document.createElement('button');
                             adminBtn.className = 'nav-btn';
                             adminBtn.dataset.page = 'admin-panel';
                             adminBtn.innerHTML = '<i class="fas fa-user-shield"></i><span>Admin</span>';
                             adminBtn.addEventListener('click', () => window.showSection('admin-panel')); 
                             nav.appendChild(adminBtn);
                         }
                    }

                    setupUserListener();
                    window.showSection('menu-page');
                } else {
                    console.log("Kullanıcı oturumu yok, anonim giriş bekleniyor.");
                }
            });
        };
        
        window.addEventListener('load', initApp);

        // Toast ve Modal Fonksiyonları
        let toastCounter = 0;
        window.showToast = (message, type = 'info', sticky = false) => {
            const toastContainer = document.getElementById('toast-container');
            const id = `toast-${toastCounter++}`;
            
            let bgColor = 'bg-blue-500';
            let icon = 'fas fa-info-circle';
            if (type === 'success') { bgColor = 'bg-green-500'; icon = 'fas fa-check-circle'; }
            else if (type === 'error') { bgColor = 'bg-red-500'; icon = 'fas fa-exclamation-triangle'; }
            else if (type === 'warning') { bgColor = 'bg-yellow-500'; icon = 'fas fa-exclamation-circle'; }

            const toast = document.createElement('div');
            toast.id = id;
            toast.className = `p-3 rounded-xl shadow-lg text-white text-sm flex items-center space-x-2 animate-slide-in-up ${bgColor} transition duration-300 transform opacity-0`;
            toast.innerHTML = `<i class="${icon}"></i><span>${message}</span>`;
            
            setTimeout(() => toast.classList.remove('opacity-0'), 10);
            
            toastContainer.appendChild(toast);

            if (!sticky) {
                setTimeout(() => {
                    toast.classList.add('opacity-0');
                    toast.classList.add('animate-slide-out-down');
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }
            return id;
        };
        
        window.closeToast = (id) => {
            const toast = document.getElementById(id);
            if (toast) {
                toast.classList.add('opacity-0');
                toast.classList.add('animate-slide-out-down');
                setTimeout(() => toast.remove(), 300);
            }
        };

        window.showCustomConfirm = (message, onConfirm) => {
            const modal = document.getElementById('custom-confirm-modal');
            const messageEl = document.getElementById('confirm-message');
            const confirmBtn = document.getElementById('confirm-action-btn');
            const cancelBtn = document.getElementById('cancel-action-btn');

            messageEl.textContent = message;
            
            // Önceki event listener'ları kaldır
            confirmBtn.onclick = null;
            cancelBtn.onclick = null;

            const handleConfirm = () => {
                onConfirm();
                modal.classList.add('hidden');
            };

            const handleCancel = () => {
                modal.classList.add('hidden');
            };

            confirmBtn.onclick = handleConfirm;
            cancelBtn.onclick = handleCancel;

            modal.classList.remove('hidden');
        };

    </script>
    
    <!-- Özel Stil Blokları -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');
        :root {
            --font-family: 'Nunito', sans-serif;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #1c1c1e;
            --subtle-text: #888;
            /* Mavi Tema */
            --primary-color: #2196F3; /* Mavi */
            --primary-color-hover: #1976D2; /* Koyu Mavi */
            --accent-color: #00BCD4; /* Turkuaz */
            --border-color: #e0e0e0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
            padding-bottom: 70px; /* Navigasyon çubuğu için boşluk */
        }

        .app-container {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--bg-color);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 15px;
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        
        .main-content {
            padding: 15px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-in-out;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-color-hover);
            transform: translateY(-1px);
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }


        /* Navigasyon Stili */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
            display: flex;
            justify-content: space-around;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 8px 0;
            max-width: 420px;
            margin: 0 auto;
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5px 10px;
            color: var(--subtle-text);
            transition: color 0.2s ease;
            font-size: 0.75rem;
            line-height: 1.2;
        }

        .nav-btn i {
            font-size: 1.25rem;
            margin-bottom: 3px;
        }

        .nav-btn.active {
            color: var(--primary-color);
        }

        /* Animasyonlu Arkaplan (Blue/White) */
        .animated-bg {
            position: relative;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            overflow: hidden;
        }

        .animated-bg::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(30deg);
            animation: move-bg 15s infinite linear;
        }

        @keyframes move-bg {
            0% { transform: translate(0, 0) rotate(30deg); }
            100% { transform: translate(-50%, -50%) rotate(30deg); }
        }

        /* Toast Animasyonları */
        @keyframes slide-in-up {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slide-out-down {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(100%); opacity: 0; }
        }

        .animate-slide-in-up {
            animation: slide-in-up 0.3s forwards;
        }
        .animate-slide-out-down {
            animation: slide-out-down 0.3s forwards;
        }

    </style>
</head>
<body>

    <!-- Toast Container (Mesaj Kutusu) -->
    <div id="toast-container" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 z-[100] w-full max-w-xs space-y-2 pointer-events-none p-4">
        <!-- Toast mesajları buraya eklenecek -->
    </div>

    <!-- Custom Confirm Modal -->
    <div id="custom-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Onay Gerekiyor</h3>
            <p id="confirm-message" class="mb-6 text-gray-600"></p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-action-btn" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">İptal</button>
                <button id="confirm-action-btn" class="px-4 py-2 bg-[var(--primary-color)] text-white font-semibold rounded-lg hover:bg-[var(--primary-color-hover)] transition">Onayla</button>
            </div>
        </div>
    </div>


    <div class="app-container">

        <!-- Yükleme Ekranı -->
        <section id="loading-page" class="app-section fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
            <div class="w-16 h-16 border-4 border-t-4 border-t-[var(--primary-color)] border-gray-200 rounded-full animate-spin"></div>
            <p class="mt-4 text-gray-600 font-semibold">AdsBux yükleniyor...</p>
        </section>

        <!-- Ana Menü Sayfası -->
        <section id="menu-page" class="app-section hidden">
            <header class="header animated-bg">
                <div class="flex items-center justify-between mb-4">
                    <h1 class="text-2xl font-extrabold flex items-center">
                        <i class="fas fa-gem mr-2 text-white"></i> AdsBux
                        <span id="admin-indicator" class="ml-2 text-xs bg-red-500 px-2 py-1 rounded-full hidden">ADMİN</span>
                    </h1>
                </div>
                <div class="text-center bg-white bg-opacity-20 backdrop-blur-sm p-4 rounded-xl shadow-inner">
                    <p class="text-sm font-semibold opacity-80">BUX Bakiyeniz</p>
                    <p class="text-4xl font-black mt-1" id="bux-balance">0.00</p>
                </div>
            </header>

            <div class="main-content space-y-5">
                
                <!-- Reklam İzle Kartı -->
                <div class="card p-5 text-center">
                    <h2 class="text-xl font-bold mb-3 text-gray-800">Reklam İzle & BUX Kazan</h2>
                    <p class="text-gray-500 mb-4">Her reklam izleme başı rastgele 5 ile 50 BUX kazanma şansı.</p>
                    <button id="watch-ad-btn" class="btn-primary w-full flex items-center justify-center space-x-2">
                        <i class="fas fa-play-circle text-xl"></i>
                        <span>REKLAM İZLE</span>
                    </button>
                </div>

                <!-- Oranlar Kartı -->
                <div class="card p-5">
                    <h2 class="text-xl font-bold mb-3 text-gray-800 flex items-center">
                        <i class="fas fa-percentage mr-2 text-[var(--accent-color)]"></i>
                        Kazanç Oranları
                    </h2>
                    <div class="space-y-2" id="bux-rates">
                        <!-- Oranlar JS ile doldurulacak -->
                    </div>
                </div>

                <!-- Diğer Bilgiler -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="card p-4 text-center">
                        <i class="fas fa-exchange-alt text-2xl mb-1 text-blue-500"></i>
                        <p class="text-xs text-gray-500">Dönüşüm</p>
                        <p class="font-bold">100 BUX = 1 Robux</p>
                    </div>
                    <div class="card p-4 text-center">
                        <i class="fas fa-hand-holding-usd text-2xl mb-1 text-green-500"></i>
                        <p class="text-xs text-gray-500">Min. Çekim</p>
                        <p class="font-bold">5 Robux (500 BUX)</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Cüzdan Sayfası -->
        <section id="wallet-page" class="app-section hidden">
            <div class="header animated-bg">
                <h1 class="text-2xl font-extrabold mb-4 pt-4 px-4">Cüzdanım</h1>
                <div class="text-center bg-white bg-opacity-20 backdrop-blur-sm p-4 mx-4 rounded-xl shadow-inner mb-4">
                    <p class="text-sm font-semibold opacity-80">Toplam BUX Bakiyesi</p>
                    <p class="text-4xl font-black mt-1" id="bux-balance-wallet">0.00</p>
                </div>
            </div>
            <div class="main-content space-y-5">
                 <div class="card p-5">
                    <h2 class="text-xl font-bold mb-3 text-gray-800 flex items-center">
                        <i class="fab fa-battle-net mr-2 text-[var(--accent-color)]"></i>
                        Robux Dönüşümü
                    </h2>
                    <p class="text-gray-600 mb-3">Hesabınızdaki BUX miktarı ile alabileceğiniz yaklaşık Robux miktarı:</p>
                    <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg border border-blue-100">
                        <span class="text-lg font-semibold text-blue-700">Robux Eşdeğeri:</span>
                        <span class="text-2xl font-extrabold text-blue-900" id="wallet-robux-equivalent">0.00</span>
                    </div>
                    <button onclick="window.showSection('withdraw-page')" class="btn-primary w-full mt-4">
                        Robux Çekimi Yap
                    </button>
                 </div>
                 
                 <!-- Telegram ID'yi göster -->
                 <div class="card p-5">
                    <h2 class="text-xl font-bold mb-3 text-gray-800 flex items-center">
                        <i class="fas fa-id-badge mr-2 text-red-500"></i>
                        Kullanıcı ID'niz (TG)
                    </h2>
                    <p class="text-gray-600 mb-3">Bu ID, adminlerin size ödeme yapması için önemlidir.</p>
                    <input id="referral-code-input" type="text" readonly :value="telegramId" placeholder="ID yükleniyor..." class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-center font-bold text-gray-700 text-sm">
                 </div>
            </div>
        </section>

        <!-- Para Çekme Sayfası -->
        <section id="withdraw-page" class="app-section hidden">
            <div class="header animated-bg">
                <h1 class="text-2xl font-extrabold pt-4 px-4 mb-4">Para Çekme</h1>
            </div>
            <div class="main-content space-y-6">

                <!-- Bakiye Bilgisi -->
                <div class="card p-5 text-center">
                    <p class="text-sm text-gray-500">Çekilebilir Maksimum Robux Miktarı:</p>
                    <p class="text-3xl font-black text-gray-800" id="max-withdraw-robux">0</p>
                    <p class="text-xs text-gray-400 mt-1">Min. Çekim: ${MIN_ROBUX_WITHDRAW} Robux</p>
                </div>

                <!-- Çekim Yöntemi Seçimi -->
                <div class="card p-5">
                    <h2 class="text-lg font-bold mb-3 text-gray-800">Çekim Yöntemi Seçin</h2>
                    <div class="space-y-2">
                        <label class="flex items-center space-x-3 p-3 border-2 border-[var(--primary-color)] rounded-lg bg-blue-50 cursor-pointer">
                            <input type="radio" id="withdraw-robux" name="withdraw-type" value="robux" checked class="form-radio h-5 w-5 text-[var(--primary-color)]">
                            <span class="text-gray-700 font-semibold">Robux (Gamepass ile)</span>
                        </label>
                        <label class="flex items-center space-x-3 p-3 border-2 border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed">
                            <input type="radio" id="withdraw-giftcard" name="withdraw-type" value="giftcard" disabled class="form-radio h-5 w-5 text-gray-400">
                            <span class="text-gray-500 font-semibold">Giftcards (Yakında)</span>
                        </label>
                    </div>
                </div>

                <!-- Çekim Formu -->
                <div class="card p-5">
                    <h2 class="text-lg font-bold mb-3 text-gray-800">Çekim Detayları</h2>
                    
                    <div id="giftcard-coming-soon" class="hidden text-center p-4 bg-yellow-50 rounded-lg mb-4">
                        <p class="text-yellow-700 font-semibold">Giftcard çekimi yakında aktif olacaktır.</p>
                    </div>

                    <div id="gamepass-link-container">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Robux Miktarı (Robux)</label>
                        <input id="withdraw-input" type="number" min="5" step="1" placeholder="Minimum 5 Robux" class="w-full p-3 border border-gray-300 rounded-lg mb-2 focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]">
                        <p id="withdraw-error" class="text-red-500 text-sm mb-4 font-medium h-4"></p>

                        <!-- KOMİSYON GÖRÜNÜRLÜĞÜ -->
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Komisyon (%${WITHDRAWAL_COMMISSION_PERCENT}):</span>
                                <span id="commission-display" class="font-semibold text-red-600">0.00 Robux</span>
                            </div>
                            <div class="flex justify-between text-lg font-bold border-t pt-2">
                                <span>Net Ödenecek Miktar:</span>
                                <span id="net-robux-display" class="text-green-600">0.00 Robux</span>
                            </div>
                        </div>
                        <!-- /KOMİSYON GÖRÜNÜRLÜĞÜ -->

                        <label class="block text-sm font-medium text-gray-700 mb-1">Robux Gamepass Linki</label>
                        <input id="gamepass-link-input" type="url" placeholder="https://www.roblox.com/game-pass/..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)]">
                    </div>
                    
                    <p class="text-gray-500 text-xs mt-4">
                        Çekim talepleri admin onayı ile Gamepass linki üzerinden gerçekleştirilecektir.
                    </p>
                    <button id="confirm-withdraw-btn" class="btn-primary w-full mt-4" disabled>
                        Çekim Yap
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Admin Sayfası -->
        <section id="admin-panel" class="app-section hidden">
            <div class="header animated-bg">
                <h1 class="text-2xl font-extrabold pt-4 px-4 mb-4">Admin Paneli</h1>
            </div>
            <div class="main-content space-y-6">
                <div class="card p-5">
                    <h2 class="text-xl font-bold mb-3 text-red-600 flex items-center">
                        <i class="fas fa-bell mr-2"></i>
                        Bekleyen Çekim Talepleri
                    </h2>
                    <ul id="withdrawal-request-list" class="space-y-3">
                        <p class="text-gray-500 text-center p-4">Bekleyen talep yok...</p>
                    </ul>
                </div>
                <p class="text-center text-xs text-gray-400">Sadece adminler bu paneli görebilir.</p>
            </div>
        </section>

        <!-- Alt Navigasyon Çubuğu -->
        <div class="bottom-nav">
            <button class="nav-btn active" data-page="menu-page">
                <i class="fas fa-home"></i>
                <span>Menü</span>
            </button>
            <button class="nav-btn" data-page="wallet-page">
                <i class="fas fa-wallet"></i>
                <span>Cüzdan</span>
            </button>
            <button class="nav-btn" data-page="withdraw-page">
                <i class="fas fa-money-bill-wave"></i>
                <span>Çekim</span>
            </button>
        </div>

    </div>

</body>
</html>

